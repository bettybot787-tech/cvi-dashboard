<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>California Viability Index</title>
  <meta name="description" content="A Sowell-inspired composite 0-100 gauge tracking California's fiscal sustainability, economic performance, affordability, and demographic incentives." />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
              600: '#475569',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    body { background-color: #0f172a; font-family: 'Inter', system-ui, sans-serif; }

    /* Gauge wrapper */
    .gauge-wrapper {
      position: relative;
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
    }
    .gauge-canvas-container {
      position: relative;
      width: 100%;
    }
    .gauge-canvas-container canvas {
      width: 100% !important;
      height: auto !important;
    }
    /* Central score overlay */
    .gauge-overlay {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      pointer-events: none;
      width: 100%;
    }

    /* Band label pills */
    .band-labels {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .band-label {
      flex: 1;
      min-width: 0;
      text-align: center;
      font-size: 0.6rem;
      font-weight: 600;
      padding: 3px 4px;
      border-radius: 4px;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Progress bar */
    .progress-bar-track {
      background: #334155;
      border-radius: 9999px;
      height: 8px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 1s ease;
    }

    /* Mini progress bar for sub-metrics */
    .mini-bar-track {
      background: #334155;
      border-radius: 9999px;
      height: 6px;
      overflow: hidden;
    }
    .mini-bar-fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 1s ease;
    }

    /* Score delta badge */
    .delta-up   { color: #22c55e; }
    .delta-down { color: #ef4444; }
    .delta-flat { color: #94a3b8; }

    /* News impact dots */
    .dot-negative { background: #ef4444; }
    .dot-positive { background: #22c55e; }
    .dot-neutral  { background: #94a3b8; }

    /* Animate score number */
    @keyframes scoreIn {
      from { opacity: 0; transform: translateX(-50%) scale(0.7); }
      to   { opacity: 1; transform: translateX(-50%) scale(1); }
    }
    .score-animate { animation: scoreIn 0.6s cubic-bezier(0.34,1.56,0.64,1) 0.3s both; }

    /* Subtle card hover */
    .factor-card { transition: border-color 0.2s, box-shadow 0.2s; }
    .factor-card:hover { border-color: #64748b; box-shadow: 0 0 0 1px #475569; }

    /* Sparkline tooltip hide */
    .sparkline-container { position: relative; height: 80px; }

    /* Details/summary styling */
    details summary { cursor: pointer; list-style: none; }
    details summary::-webkit-details-marker { display: none; }
    details summary::marker { display: none; }
    details[open] .chevron-icon { transform: rotate(180deg); }
    .chevron-icon { transition: transform 0.2s ease; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

    /* ── Progressive Disclosure: Info Icon + Tooltip ── */
    .info-anchor {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .info-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #334155;
      color: #64748b;
      font-size: 0.65rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      flex-shrink: 0;
      transition: background 0.15s, color 0.15s;
      user-select: none;
      line-height: 1;
    }
    .info-btn:hover, .info-anchor.open .info-btn {
      background: #475569;
      color: #cbd5e1;
    }
    .info-tooltip {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      z-index: 100;
      width: 270px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.72rem;
      color: #94a3b8;
      line-height: 1.5;
      box-shadow: 0 12px 32px rgba(0,0,0,0.5);
    }
    .info-anchor.open .info-tooltip { display: block; }
    .info-tooltip .tooltip-formula {
      font-family: 'JetBrains Mono', monospace;
      background: #0f172a;
      border: 1px solid #1e293b;
      border-radius: 6px;
      padding: 5px 8px;
      font-size: 0.68rem;
      color: #7dd3fc;
      margin: 6px 0;
      word-break: break-all;
    }
    .info-tooltip .tooltip-section {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #334155;
    }

    /* ── Traffic-light dots ── */
    .tl-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      flex-shrink: 0;
      display: inline-block;
    }
    .tl-dot.red    { background: #ef4444; }
    .tl-dot.yellow { background: #eab308; }
    .tl-dot.green  { background: #22c55e; }

    /* ── Category expand toggle ── */
    .cat-details-btn {
      font-size: 0.65rem;
      font-weight: 600;
      color: #475569;
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: color 0.15s, background 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .cat-details-btn:hover { color: #94a3b8; background: #1e293b; }
    .cat-detail-panel { display: none; }
    .cat-detail-panel.open { display: block; }

    /* ── Reasoning truncation ── */
    .reasoning-clamp { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .reasoning-clamp.expanded { display: block; overflow: visible; }
    .read-more-btn { background: none; border: none; color: #64748b; font-size: 0.75rem; cursor: pointer; padding: 4px 0; display: inline-flex; align-items: center; gap: 3px; }
    .read-more-btn:hover { color: #94a3b8; }
  </style>
</head>

<body class="min-h-screen text-slate-100 antialiased">

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white font-black text-sm">CA</div>
        <div>
          <h1 class="text-sm font-bold text-white leading-tight">California Viability Index</h1>
          <p class="text-xs text-slate-400 leading-tight">Sowell-inspired 0-100 structural health gauge</p>
        </div>
      </div>
      <div class="text-right">
        <div id="header-score" class="text-lg font-black text-orange-400">--</div>
        <div id="header-updated" class="text-xs text-slate-500">Loading...</div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">

    <!-- LOADING STATE -->
    <div id="loading-state" class="flex flex-col items-center justify-center py-20 text-slate-500">
      <svg class="animate-spin w-8 h-8 mb-4" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/>
      </svg>
      <p class="text-sm">Loading CVI data...</p>
    </div>

    <!-- MAIN CONTENT (hidden until data loads) -->
    <div id="main-content" class="hidden space-y-8">

      <!-- GAUGE + SCORE HERO -->
      <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6 md:p-10">
        <div class="flex flex-col lg:flex-row items-center gap-8 lg:gap-12">

          <!-- Gauge -->
          <div class="gauge-wrapper flex-shrink-0 w-full lg:w-[420px]">
            <div class="gauge-canvas-container">
              <canvas id="gaugeChart"></canvas>
              <!-- Score Overlay -->
              <div class="gauge-overlay score-animate">
                <div id="gauge-score" class="text-6xl md:text-7xl font-black leading-none" style="color:#f97316">--</div>
                <div class="text-slate-400 text-sm font-medium mt-1">out of 100</div>
              </div>
            </div>

            <!-- Band labels row -->
            <div class="band-labels mt-2 px-1">
              <div class="band-label" style="background:#dc262622;color:#dc2626;">Leave Now<br/>0-25</div>
              <div class="band-label" style="background:#f9731622;color:#f97316;">Consider<br/>26-45</div>
              <div class="band-label" style="background:#eab30822;color:#eab308;">Neutral<br/>46-60</div>
              <div class="band-label" style="background:#84cc1622;color:#84cc16;">Attractive<br/>61-80</div>
              <div class="band-label" style="background:#22c55e22;color:#22c55e;">Move Here<br/>81-100</div>
            </div>
          </div>

          <!-- Score Details -->
          <div class="flex-1 text-center lg:text-left space-y-4">

            <div>
              <div id="category-badge" class="inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-3" style="background:#f9731622;color:#f97316;">--</div>
              <h2 id="category-label" class="text-3xl md:text-4xl font-black text-white leading-tight">Loading...</h2>
            </div>

            <!-- Delta -->
            <div id="delta-block" class="flex items-center justify-center lg:justify-start gap-2 text-sm">
              <span id="delta-arrow" class="text-xl font-black delta-flat">-></span>
              <span id="delta-text" class="text-slate-400">--</span>
            </div>

            <!-- Sowell Insight -->
            <blockquote id="sowell-insight" class="border-l-2 border-slate-600 pl-4 italic text-slate-400 text-sm leading-relaxed"></blockquote>

            <!-- Mini stats row -->
            <div class="grid grid-cols-3 gap-3 mt-2">
              <div class="bg-slate-900/60 rounded-xl p-3 text-center">
                <div id="stat-previous" class="text-xl font-bold text-slate-300">--</div>
                <div class="text-xs text-slate-500 mt-0.5">Last Week</div>
              </div>
              <div class="bg-slate-900/60 rounded-xl p-3 text-center">
                <div id="stat-proj-2027" class="text-xl font-bold text-slate-300">--</div>
                <div class="text-xs text-slate-500 mt-0.5">Proj. 2027</div>
              </div>
              <div class="bg-slate-900/60 rounded-xl p-3 text-center">
                <div id="stat-proj-2031" class="text-xl font-bold text-slate-300">--</div>
                <div class="text-xs text-slate-500 mt-0.5">Proj. 2031</div>
              </div>
            </div>

          </div>
        </div>

        <!-- History sparkline -->
        <div id="sparkline-section" class="hidden mt-6 pt-6 border-t border-slate-700/50">
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Historical Score (last 12 weeks)</p>
          <div class="sparkline-container">
            <canvas id="sparklineChart"></canvas>
          </div>
        </div>
      </section>

      <!-- REASONING -->
      <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Analysis &amp; Reasoning</h3>
        <p id="reasoning-text" class="text-slate-300 leading-relaxed text-sm md:text-base"></p>
        <div id="delta-summary" class="mt-4 bg-slate-900/50 rounded-xl p-4 border border-slate-700/50 text-sm text-slate-400 italic"></div>
      </section>

      <!-- CATEGORY BREAKDOWN -->
      <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">Category Breakdown</h3>
        <div id="category-breakdown" class="space-y-4"></div>
      </section>

      <!-- SCORING METHODOLOGY (collapsible) -->
      <section id="methodology-section" class="hidden">
        <details class="bg-slate-800/40 border border-slate-700/50 rounded-2xl">
          <summary class="p-6 flex items-center justify-between cursor-pointer select-none">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Scoring Methodology</h3>
            <svg class="chevron-icon w-5 h-5 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </summary>
          <div class="px-6 pb-6 space-y-6">

            <!-- Composite Formula -->
            <div>
              <h4 class="text-sm font-semibold text-slate-300 mb-3">Composite Formula</h4>
              <div class="bg-slate-900/80 border border-slate-700/30 rounded-xl p-4 font-mono text-xs text-slate-400 leading-relaxed overflow-x-auto">
                <div class="text-slate-500 mb-2">CVI = Fiscal x 0.25 + Econ x 0.20 + Afford x 0.20 + Demo x 0.15 + QoL x 0.10 + Policy x 0.10</div>
                <div id="methodology-formula-expanded" class="text-slate-300"></div>
              </div>
            </div>

            <!-- Band Definitions -->
            <div>
              <h4 class="text-sm font-semibold text-slate-300 mb-3">Band Definitions</h4>
              <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
                <div class="flex items-center gap-2 bg-slate-900/60 rounded-lg px-3 py-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:#dc2626;"></span>
                  <div>
                    <div class="text-xs font-bold" style="color:#dc2626;">Leave Now</div>
                    <div class="text-xs text-slate-500">0-25</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/60 rounded-lg px-3 py-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:#f97316;"></span>
                  <div>
                    <div class="text-xs font-bold" style="color:#f97316;">Consider Leaving</div>
                    <div class="text-xs text-slate-500">26-45</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/60 rounded-lg px-3 py-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:#eab308;"></span>
                  <div>
                    <div class="text-xs font-bold" style="color:#eab308;">Neutral / Monitor</div>
                    <div class="text-xs text-slate-500">46-60</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/60 rounded-lg px-3 py-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:#84cc16;"></span>
                  <div>
                    <div class="text-xs font-bold" style="color:#84cc16;">Mildly Attractive</div>
                    <div class="text-xs text-slate-500">61-80</div>
                  </div>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/60 rounded-lg px-3 py-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:#22c55e;"></span>
                  <div>
                    <div class="text-xs font-bold" style="color:#22c55e;">Move Here</div>
                    <div class="text-xs text-slate-500">81-100</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Data Sources -->
            <div>
              <h4 class="text-sm font-semibold text-slate-300 mb-3">Data Sources</h4>
              <div id="methodology-sources" class="bg-slate-900/60 rounded-xl overflow-hidden">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="border-b border-slate-700/50">
                      <th class="text-left px-3 py-2 text-slate-500 font-semibold">Factor</th>
                      <th class="text-left px-3 py-2 text-slate-500 font-semibold">Status</th>
                      <th class="text-left px-3 py-2 text-slate-500 font-semibold">Source</th>
                    </tr>
                  </thead>
                  <tbody id="methodology-sources-body"></tbody>
                </table>
              </div>
            </div>

            <!-- Methodology Note -->
            <div class="border-t border-slate-700/30 pt-4">
              <p class="text-xs text-slate-500 leading-relaxed italic">Based on the CVI model -- a Thomas Sowell-inspired composite indicator focusing on incentives, data, and trade-offs. Each metric is normalized 0-100 (100 = best U.S. benchmark) and weighted by category importance.</p>
            </div>

          </div>
        </details>
      </section>

      <!-- TWO-COLUMN: FACTORS + NEWS -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Key Factors -->
        <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6">
          <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">Key Influencing Factors</h3>
          <div id="factors-list" class="space-y-3"></div>
        </section>

        <!-- Recent News -->
        <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6">
          <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">Recent Relevant News</h3>
          <div id="news-list" class="space-y-4"></div>
        </section>

      </div>

      <!-- PROJECTIONS -->
      <section class="bg-slate-800/60 border border-slate-700/50 rounded-2xl p-6">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5">Projections &amp; Migration Correlation</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <p class="text-sm font-semibold text-slate-400 mb-3">Score Trajectory (Under Current Trends)</p>
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-slate-900/60 rounded-xl p-4 text-center">
                <div id="proj-2027" class="text-2xl font-black text-red-400">--</div>
                <div class="text-xs text-slate-500 mt-1">2027</div>
              </div>
              <div class="bg-slate-900/60 rounded-xl p-4 text-center">
                <div id="proj-2029" class="text-2xl font-black text-red-500">--</div>
                <div class="text-xs text-slate-500 mt-1">2029</div>
              </div>
              <div class="bg-slate-900/60 rounded-xl p-4 text-center">
                <div id="proj-2031" class="text-2xl font-black text-red-600">--</div>
                <div class="text-xs text-slate-500 mt-1">2031</div>
              </div>
            </div>
          </div>
          <div>
            <p class="text-sm font-semibold text-slate-400 mb-3">Migration Correlation</p>
            <div class="bg-slate-900/60 rounded-xl p-4">
              <p id="migration-correlation" class="text-slate-300 text-sm leading-relaxed"></p>
            </div>
          </div>
        </div>
      </section>

    </div><!-- /main-content -->
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800 mt-8 py-6">
    <div class="max-w-6xl mx-auto px-4 text-center text-xs text-slate-600 space-y-1">
      <p>California Viability Index -- Sowell-inspired composite indicator. Not financial or political advice. Data-driven incentive analysis only.</p>
      <p>Sources: BLS . U.S. Census . CA DOF / LAO . BEA . Tax Foundation . CalPERS . HUD . PPIC . FRED</p>
      <p>Updated automatically every Monday via GitHub Actions. Open source -- <a href="https://github.com/bettybot787-tech/cvi-dashboard" class="underline hover:text-slate-400 transition-colors">View on GitHub</a></p>
    </div>
  </footer>

  <!-- JAVASCRIPT -->
  <script>
    // ─── BAND DEFINITIONS ──────────────────────────────────────
    const BANDS = [
      { min: 0,  max: 25,  label: 'Leave California Now',       color: '#dc2626', bg: '#dc262615' },
      { min: 26, max: 45,  label: 'Strongly Consider Leaving',  color: '#f97316', bg: '#f9731615' },
      { min: 46, max: 60,  label: 'Neutral / Monitor Closely',  color: '#eab308', bg: '#eab30815' },
      { min: 61, max: 80,  label: 'Mildly Attractive',          color: '#84cc16', bg: '#84cc1615' },
      { min: 81, max: 100, label: 'Move to California Now',     color: '#22c55e', bg: '#22c55e15' },
    ];

    function getBand(score) {
      return BANDS.find(b => score >= b.min && score <= b.max) || BANDS[0];
    }

    // ─── GAUGE CHART ───────────────────────────────────────────
    let gaugeChart = null;

    // Custom needle plugin
    const needlePlugin = {
      id: 'needlePlugin',
      afterDraw(chart) {
        if (chart.config.type !== 'doughnut') return;
        const { ctx, chartArea } = chart;
        if (!chartArea) return;

        const score = chart.config.options.plugins.needle.score;
        const cx = (chartArea.left + chartArea.right) / 2;
        const cy = (chartArea.bottom + chartArea.top) / 2 + (chartArea.bottom - chartArea.top) * 0.22;

        const angleRad = (Math.PI) * (score / 100);
        const needleAngle = Math.PI - angleRad;

        const radius = Math.min(chartArea.right - chartArea.left, chartArea.bottom - chartArea.top) * 0.42;
        const needleLength = radius * 0.85;
        const needleWidth = 3;

        const tipX = cx + needleLength * Math.cos(needleAngle);
        const tipY = cy - needleLength * Math.sin(needleAngle);

        // Draw shadow
        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 6;

        // Needle line
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(tipX, tipY);
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = needleWidth;
        ctx.lineCap = 'round';
        ctx.stroke();

        // Small triangle tip
        const tipAngle = Math.atan2(cy - tipY, tipX - cx);
        ctx.beginPath();
        ctx.moveTo(tipX, tipY);
        ctx.lineTo(
          tipX - 10 * Math.cos(tipAngle - 0.3),
          tipY + 10 * Math.sin(tipAngle - 0.3)
        );
        ctx.lineTo(
          tipX - 10 * Math.cos(tipAngle + 0.3),
          tipY + 10 * Math.sin(tipAngle + 0.3)
        );
        ctx.closePath();
        ctx.fillStyle = '#ffffff';
        ctx.fill();

        ctx.restore();

        // Center dot
        ctx.save();
        ctx.beginPath();
        ctx.arc(cx, cy, 10, 0, Math.PI * 2);
        ctx.fillStyle = '#1e293b';
        ctx.fill();
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }
    };

    Chart.register(needlePlugin);

    function buildGauge(score) {
      const band = getBand(score);
      const ctx = document.getElementById('gaugeChart').getContext('2d');

      if (gaugeChart) gaugeChart.destroy();

      gaugeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [25, 20, 15, 20, 20],
            backgroundColor: ['#dc2626', '#f97316', '#eab308', '#84cc16', '#22c55e'],
            borderWidth: 0,
            borderRadius: 0,
            hoverOffset: 0,
          }]
        },
        options: {
          circumference: 180,
          rotation: -90,
          cutout: '68%',
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 800, easing: 'easeInOutQuart' },
          plugins: {
            tooltip: { enabled: false },
            legend: { display: false },
            needle: { score }
          },
          events: [],
        },
        plugins: [needlePlugin]
      });

      // Set canvas aspect ratio after build
      const canvas = document.getElementById('gaugeChart');
      canvas.parentElement.style.paddingBottom = '55%';
      canvas.parentElement.style.height = '0';
      canvas.parentElement.style.position = 'relative';
      canvas.style.position = 'absolute';
      canvas.style.top = '0';
      canvas.style.left = '0';
      canvas.style.width = '100%';
      canvas.style.height = '100%';

      // Update overlay
      const scoreEl = document.getElementById('gauge-score');
      scoreEl.textContent = score;
      scoreEl.style.color = band.color;
    }

    // ─── SPARKLINE ─────────────────────────────────────────────
    let sparklineChart = null;

    function buildSparkline(history) {
      if (!history || history.length < 2) return;
      document.getElementById('sparkline-section').classList.remove('hidden');

      const labels = history.map(h => {
        const d = new Date(h.timestamp);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const scores = history.map(h => h.score);

      const ctx = document.getElementById('sparklineChart').getContext('2d');
      if (sparklineChart) sparklineChart.destroy();

      sparklineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: scores,
            borderColor: '#f97316',
            backgroundColor: 'rgba(249,115,22,0.08)',
            borderWidth: 2,
            fill: true,
            tension: 0.35,
            pointRadius: 3,
            pointBackgroundColor: '#f97316',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: '#33415540' }, ticks: { color: '#64748b', font: { size: 10 } } },
            y: { min: 0, max: 100, grid: { color: '#33415540' }, ticks: { color: '#64748b', font: { size: 10 }, stepSize: 25 } }
          },
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
        }
      });
    }

    // ─── HELPER: score color ────────────────────────────────────
    function scoreColor(score) {
      if (score >= 65) return '#22c55e';
      if (score >= 40) return '#eab308';
      return '#ef4444';
    }

    // ─── HELPER: traffic-light dot class ───────────────────────
    function tlDotClass(score) {
      if (score >= 65) return 'green';
      if (score >= 40) return 'yellow';
      return 'red';
    }

    // ─── HELPER: plain-English sub-metric status label ─────────
    function subMetricLabel(score) {
      if (score >= 80) return 'strong';
      if (score >= 65) return 'solid';
      if (score >= 50) return 'moderate';
      if (score >= 40) return 'under pressure';
      if (score >= 25) return 'well below average';
      if (score >= 10) return 'critically stressed';
      return 'near worst case';
    }

    // ─── HELPER: friendly benchmark sentence ───────────────────
    // Takes the raw benchmark string (e.g. "100 = CA equals U.S.; 80+ = gap <1pt")
    // and returns a short human-readable sentence for the tooltip.
    function friendlyBenchmark(f) {
      const b = f.benchmark || '';
      // Find the "100 = ..." anchor and rephrase
      const m = b.match(/100\s*=\s*([^;]+)/i);
      const ideal = m ? m[1].trim().toLowerCase() : null;
      const score = f.raw_score;
      let qualitative;
      if (score >= 80) qualitative = 'performing well';
      else if (score >= 65) qualitative = 'above average';
      else if (score >= 50) qualitative = 'near average';
      else if (score >= 35) qualitative = 'below average';
      else qualitative = 'near the bottom';

      if (ideal) {
        return `A perfect score means ${ideal}. California is currently ${qualitative} on this measure.`;
      }
      return `California is currently ${qualitative} on this measure.`;
    }

    // ─── HELPER: strip "Fixed proxy: " prefix from value text ──
    function cleanValue(value) {
      return (value || '').replace(/^Fixed proxy:\s*/i, '').replace(/^Fixed:\s*/i, '');
    }

    // ─── PROGRESSIVE DISCLOSURE: info tooltip toggle ───────────
    function initInfoTooltips() {
      document.addEventListener('click', function(e) {
        // Close all open tooltips when clicking outside
        if (!e.target.closest('.info-anchor')) {
          document.querySelectorAll('.info-anchor.open').forEach(el => el.classList.remove('open'));
        }
      });
    }

    function toggleInfoAnchor(el) {
      const isOpen = el.classList.contains('open');
      document.querySelectorAll('.info-anchor.open').forEach(a => a.classList.remove('open'));
      if (!isOpen) el.classList.add('open');
    }

    // ─── RENDER CATEGORY BREAKDOWN ─────────────────────────────
    function renderCategories(breakdown) {
      const container = document.getElementById('category-breakdown');
      container.innerHTML = '';

      breakdown.forEach((cat, catIdx) => {
        const score = cat.sub_score;
        const color = scoreColor(score);
        const trendIcon = { improving: '\u2191', deteriorating: '\u2193', stable: '\u2192' }[cat.trend] || '\u2192';
        const trendColor = { improving: 'text-green-400', deteriorating: 'text-red-400', stable: 'text-slate-400' }[cat.trend] || 'text-slate-400';
        const panelId = 'cat-panel-' + catIdx;

        // Traffic-light dot rows (top layer — no numbers, no formulas)
        let tlRowsHtml = '';
        if (cat.sub_metrics && Array.isArray(cat.sub_metrics) && cat.sub_metrics.length > 0) {
          tlRowsHtml = cat.sub_metrics.map(sm => {
            const dotCls = tlDotClass(sm.score);
            const statusLabel = subMetricLabel(sm.score);
            return `
              <div class="flex items-center gap-2.5 py-1">
                <span class="tl-dot ${dotCls}"></span>
                <span class="text-xs text-slate-400">${escapeHtml(sm.name)}</span>
                <span class="text-xs text-slate-600 italic">${statusLabel}</span>
              </div>
            `;
          }).join('');
        }

        // Expanded detail rows (revealed on click — raw scores + formulas)
        const hasWeightedContrib = typeof cat.weighted_contribution === 'number';
        const maxPossible = (cat.weight * 100).toFixed(1);
        const contribLine = hasWeightedContrib
          ? `<p class="text-xs text-slate-600 mt-3 pt-2 border-t border-slate-700/30">This category contributes <span class="text-slate-400 font-semibold">${cat.weighted_contribution.toFixed(1)}</span> of <span class="text-slate-400">${maxPossible}</span> possible points to the total CVI score (weight: ${Math.round(cat.weight * 100)}%).</p>`
          : '';

        let detailRowsHtml = '';
        if (cat.sub_metrics && Array.isArray(cat.sub_metrics) && cat.sub_metrics.length > 0) {
          detailRowsHtml = cat.sub_metrics.map((sm, idx) => {
            const isLast = idx === cat.sub_metrics.length - 1;
            const prefix = isLast ? '\u2514\u2500' : '\u251C\u2500';
            const smColor = scoreColor(sm.score);
            const smWeightPct = typeof sm.weight_in_cat === 'number' ? Math.round(sm.weight_in_cat * 100) : '';
            const formulaHtml = sm.formula
              ? `<div class="font-mono text-slate-500 text-[0.65rem] mt-0.5 pl-5">${escapeHtml(sm.formula)}</div>`
              : '';
            return `
              <div class="py-1">
                <div class="flex items-center gap-2 text-xs">
                  <span class="text-slate-600 font-mono flex-shrink-0">${prefix}</span>
                  <span class="text-slate-400 flex-shrink-0">${escapeHtml(sm.name)}${smWeightPct ? ` <span class="text-slate-600">(${smWeightPct}%)</span>` : ''}</span>
                  <div class="flex-1 mini-bar-track max-w-[80px]">
                    <div class="mini-bar-fill" style="width:${sm.score}%;background:${smColor};"></div>
                  </div>
                  <span class="font-bold flex-shrink-0" style="color:${smColor}">${sm.score}/100</span>
                </div>
                ${formulaHtml}
              </div>
            `;
          }).join('');
        }

        container.insertAdjacentHTML('beforeend', `
          <div class="rounded-xl bg-slate-900/30 border border-slate-700/40 p-4 space-y-2">

            <!-- Header row: name · score · trend · details toggle -->
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <span class="font-semibold text-slate-200 text-sm truncate">${escapeHtml(cat.name)}</span>
                <span class="text-xs font-bold ${trendColor} flex-shrink-0">${trendIcon}</span>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <span class="font-bold text-sm" style="color:${color}">${score}</span>
                <button class="cat-details-btn" onclick="(function(btn){var p=document.getElementById('${panelId}');p.classList.toggle('open');btn.textContent=p.classList.contains('open')?'\u25be Details':'\u25b8 Details';})(this)">\u25b8 Details</button>
              </div>
            </div>

            <!-- Progress bar -->
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width:${score}%;background:${color};"></div>
            </div>

            <!-- Traffic-light sub-metric dots (default visible) -->
            ${tlRowsHtml ? `<div class="space-y-0 mt-1">${tlRowsHtml}</div>` : ''}

            <!-- Expanded detail panel (hidden by default) -->
            <div id="${panelId}" class="cat-detail-panel">
              <div class="border-t border-slate-700/30 pt-3 mt-1 space-y-0">
                ${detailRowsHtml}
              </div>
              ${contribLine}
            </div>

          </div>
        `);
      });
    }

    // ─── RENDER FACTORS ────────────────────────────────────────
    function renderFactors(factors) {
      const container = document.getElementById('factors-list');
      container.innerHTML = '';

      factors.forEach((f, fi) => {
        const hasNewSchema = typeof f.raw_score === 'number';

        if (hasNewSchema) {
          const rawScore = f.raw_score;
          const barColor = scoreColor(rawScore);
          const anchorId = 'finfo-' + fi;

          // Direction badge
          let dirBadge = '';
          if (f.direction === 'negative') {
            dirBadge = '<span class="text-xs font-bold px-2 py-0.5 rounded-full text-red-400 bg-red-400/10">\u2193 Negative</span>';
          } else if (f.direction === 'positive') {
            dirBadge = '<span class="text-xs font-bold px-2 py-0.5 rounded-full text-green-400 bg-green-400/10">\u2191 Positive</span>';
          } else {
            dirBadge = '<span class="text-xs font-bold px-2 py-0.5 rounded-full text-yellow-400 bg-yellow-400/10">\u2192 Neutral</span>';
          }

          // Live / fallback dot (top layer — just dot + word)
          const liveDotColor = f.is_live ? 'bg-green-500' : 'bg-amber-500';
          const liveLabel = f.is_live ? 'Live' : 'Fallback';

          // Tooltip content (formula, benchmark, date, source)
          const formulaHtml = f.formula
            ? `<div class="tooltip-formula">${escapeHtml(f.formula)}</div>`
            : '';
          const benchText = f.benchmark ? friendlyBenchmark(f) : '';
          const benchHtml = benchText
            ? `<p class="tooltip-section">${escapeHtml(benchText)}</p>`
            : '';
          const dateHtml = f.data_date
            ? `<p class="tooltip-section text-slate-500">Data period: ${escapeHtml(f.data_date)}</p>`
            : '';
          const sourceHtml = f.source_url
            ? `<p class="${f.data_date ? '' : 'tooltip-section'}"><a href="${escapeHtml(f.source_url)}" target="_blank" rel="noopener" class="text-blue-400 underline hover:text-blue-300">View source \u2197</a></p>`
            : '';

          const tooltipHtml = (formulaHtml || benchHtml || dateHtml || sourceHtml)
            ? `<div class="info-tooltip">${formulaHtml}${benchHtml}${dateHtml}${sourceHtml}</div>`
            : '';

          // Clean display value — strip "Fixed proxy:" prefix
          const displayValue = cleanValue(f.value);

          container.insertAdjacentHTML('beforeend', `
            <div class="factor-card bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 relative">
              <div class="flex items-start gap-3">

                <!-- Left: name, value, score bar -->
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-200 text-sm leading-tight">${escapeHtml(f.name)}</p>
                  <p class="text-xs text-slate-400 mt-1 leading-snug">${escapeHtml(displayValue)}</p>
                  <div class="flex items-center gap-2 mt-2">
                    <div class="flex-1" style="height:6px;background:#334155;border-radius:9999px;overflow:hidden;">
                      <div style="width:${rawScore}%;height:100%;background:${barColor};border-radius:9999px;transition:width 1s ease;"></div>
                    </div>
                    <span class="text-xs font-bold flex-shrink-0" style="color:${barColor}">${rawScore}/100</span>
                  </div>
                </div>

                <!-- Right: direction badge, live dot, info icon -->
                <div class="flex flex-col items-end gap-1.5 flex-shrink-0">
                  ${dirBadge}
                  <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full ${liveDotColor} inline-block"></span>
                    <span class="text-xs text-slate-500">${liveLabel}</span>
                  </div>
                  ${tooltipHtml ? `
                  <div class="info-anchor" id="${anchorId}" onclick="toggleInfoAnchor(this)">
                    <button class="info-btn" aria-label="Show details">i</button>
                    ${tooltipHtml}
                  </div>` : ''}
                </div>

              </div>
            </div>
          `);
        } else {
          // Legacy fallback card
          container.insertAdjacentHTML('beforeend', `
            <div class="factor-card bg-slate-900/60 border border-slate-700/50 rounded-xl p-4">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-slate-200 text-sm leading-tight">${escapeHtml(f.name)}</p>
                  <p class="text-xs text-slate-400 mt-1 leading-snug">${escapeHtml(f.value)}</p>
                </div>
                <a href="${escapeHtml(f.source_url)}" target="_blank" rel="noopener" class="text-xs text-slate-500 hover:text-blue-400 transition-colors underline flex-shrink-0">Source \u2197</a>
              </div>
            </div>
          `);
        }
      });
    }

    // ─── RENDER NEWS ───────────────────────────────────────────
    function renderNews(news) {
      const container = document.getElementById('news-list');
      container.innerHTML = '';

      news.forEach(item => {
        const dotClass = { negative: 'dot-negative', positive: 'dot-positive', neutral: 'dot-neutral' }[item.impact] || 'dot-neutral';
        const impactLabel = { negative: 'Negative', positive: 'Positive', neutral: 'Neutral' }[item.impact] || 'Neutral';
        const impactColor = { negative: 'text-red-400', positive: 'text-green-400', neutral: 'text-slate-400' }[item.impact] || 'text-slate-400';
        const sourceTag = item.source ? `<span class="text-xs text-slate-500 ml-2">\u00B7 ${escapeHtml(item.source)}</span>` : '';

        container.insertAdjacentHTML('beforeend', `
          <div class="border-b border-slate-700/50 pb-4 last:border-0 last:pb-0">
            <div class="flex items-center gap-2 mb-1">
              <span class="w-2 h-2 rounded-full flex-shrink-0 ${dotClass}"></span>
              <span class="text-xs font-semibold ${impactColor}">${impactLabel}</span>
              ${sourceTag}
            </div>
            <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener" class="text-sm font-semibold text-slate-200 hover:text-blue-400 transition-colors leading-tight block mb-1">${escapeHtml(item.title)} \u2197</a>
            <p class="text-xs text-slate-500 leading-snug">${escapeHtml(item.snippet)}</p>
          </div>
        `);
      });
    }

    // ─── RENDER METHODOLOGY SECTION ─────────────────────────────
    function renderMethodology(current) {
      const section = document.getElementById('methodology-section');
      section.classList.remove('hidden');

      // Build expanded formula from category_breakdown
      const breakdown = current.category_breakdown || [];
      const formulaEl = document.getElementById('methodology-formula-expanded');

      if (breakdown.length > 0) {
        // Category short names
        const shortNames = ['Fiscal', 'Econ', 'Afford', 'Demo', 'QoL', 'Policy'];

        // Line 1: CVI = score x weight + ...
        const line1Parts = breakdown.map((cat, i) => {
          const name = shortNames[i] || cat.name.split(' ')[0];
          return `${cat.sub_score} x ${cat.weight.toFixed(2)}`;
        });
        const line1 = 'CVI = ' + line1Parts.join(' + ');

        // Line 2: = weighted values
        const weightedValues = breakdown.map(cat => {
          const wc = typeof cat.weighted_contribution === 'number'
            ? cat.weighted_contribution
            : parseFloat((cat.sub_score * cat.weight).toFixed(1));
          return wc.toFixed(1);
        });
        const line2 = '    = ' + weightedValues.join(' + ');

        // Line 3: = total -> rounded
        const total = weightedValues.reduce((sum, v) => sum + parseFloat(v), 0);
        const rounded = Math.round(total);
        const line3 = '    = ' + total.toFixed(1) + ' \u2192 ' + rounded;

        formulaEl.innerHTML =
          '<div>' + escapeHtml(line1) + '</div>' +
          '<div>' + escapeHtml(line2) + '</div>' +
          '<div class="text-orange-400 font-bold">' + escapeHtml(line3) + '</div>';
      }

      // Data sources table
      const tbody = document.getElementById('methodology-sources-body');
      tbody.innerHTML = '';

      if (current.factors && current.factors.length > 0) {
        current.factors.forEach(f => {
          const hasNewSchema = typeof f.raw_score === 'number';
          let statusDot, statusLabel;

          if (hasNewSchema) {
            statusDot = f.is_live
              ? '<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>'
              : '<span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>';
            statusLabel = f.is_live ? 'Live' : 'Fallback';
          } else {
            statusDot = '<span class="w-2 h-2 rounded-full bg-slate-500 inline-block"></span>';
            statusLabel = 'Legacy';
          }

          tbody.insertAdjacentHTML('beforeend', `
            <tr class="border-b border-slate-700/30 last:border-0">
              <td class="px-3 py-2 text-slate-300">${escapeHtml(f.name)}</td>
              <td class="px-3 py-2">
                <div class="flex items-center gap-1.5">
                  ${statusDot}
                  <span class="text-slate-400">${statusLabel}</span>
                </div>
              </td>
              <td class="px-3 py-2">
                <a href="${escapeHtml(f.source_url)}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline truncate block max-w-[200px]">${escapeHtml(extractDomain(f.source_url))}</a>
              </td>
            </tr>
          `);
        });
      }
    }

    // ─── UTILITY: extract domain from URL ───────────────────────
    function extractDomain(url) {
      try {
        const u = new URL(url);
        return u.hostname.replace(/^www\./, '');
      } catch {
        return url;
      }
    }

    // ─── UTILITY: escape HTML ───────────────────────────────────
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ─── RENDER FULL DASHBOARD ─────────────────────────────────
    function renderDashboard(current, history) {
      const band = getBand(current.score);
      const prev = current.previous_score;
      const delta = prev !== null ? current.score - prev : null;

      // Header
      document.getElementById('header-score').textContent = current.score + '/100';
      document.getElementById('header-score').style.color = band.color;
      const ts = new Date(current.timestamp);
      document.getElementById('header-updated').textContent = 'Updated ' + ts.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      // Gauge
      buildGauge(current.score);

      // Category badge
      const badge = document.getElementById('category-badge');
      badge.textContent = current.category;
      badge.style.background = band.bg;
      badge.style.color = band.color;

      // Category label
      document.getElementById('category-label').textContent = current.category;

      // Delta
      const arrowEl = document.getElementById('delta-arrow');
      const textEl = document.getElementById('delta-text');
      if (delta === null) {
        arrowEl.textContent = '\u00B7'; arrowEl.className = 'text-xl font-black delta-flat';
        textEl.textContent = current.delta_summary;
      } else if (delta > 0) {
        arrowEl.textContent = '\u2191'; arrowEl.className = 'text-xl font-black delta-up';
        textEl.textContent = '+' + delta + ' from last week (' + prev + ' \u2192 ' + current.score + ')';
      } else if (delta < 0) {
        arrowEl.textContent = '\u2193'; arrowEl.className = 'text-xl font-black delta-down';
        textEl.textContent = delta + ' from last week (' + prev + ' \u2192 ' + current.score + ')';
      } else {
        arrowEl.textContent = '\u2192'; arrowEl.className = 'text-xl font-black delta-flat';
        textEl.textContent = 'Unchanged from last week (' + current.score + ')';
      }

      // Sowell Insight
      if (current.sowell_insight) {
        document.getElementById('sowell-insight').textContent = '\u201C' + current.sowell_insight + '\u201D';
      }

      // Mini stats
      document.getElementById('stat-previous').textContent = prev !== null ? prev : '--';
      document.getElementById('stat-proj-2027').textContent = current.projections?.['2027'] ?? '--';
      document.getElementById('stat-proj-2031').textContent = current.projections?.['2031'] ?? '--';

      // Reasoning — truncated with "Read more" expand
      (function() {
        const el = document.getElementById('reasoning-text');
        const text = current.reasoning || '';
        const LIMIT = 200;
        if (text.length <= LIMIT) {
          el.textContent = text;
        } else {
          el.classList.add('reasoning-clamp');
          el.textContent = text;
          const btn = document.createElement('button');
          btn.className = 'read-more-btn';
          btn.textContent = 'Read more \u2193';
          btn.onclick = function() {
            el.classList.toggle('expanded');
            btn.textContent = el.classList.contains('expanded') ? 'Read less \u2191' : 'Read more \u2193';
          };
          el.parentNode.insertBefore(btn, el.nextSibling);
        }
      })();
      document.getElementById('delta-summary').textContent = current.delta_summary;

      // Categories
      if (current.category_breakdown) renderCategories(current.category_breakdown);

      // Methodology (always render after categories)
      renderMethodology(current);

      // Factors
      if (current.factors) renderFactors(current.factors);

      // News
      if (current.news) renderNews(current.news);

      // Projections
      document.getElementById('proj-2027').textContent = current.projections?.['2027'] ?? '--';
      document.getElementById('proj-2029').textContent = current.projections?.['2029'] ?? '--';
      document.getElementById('proj-2031').textContent = current.projections?.['2031'] ?? '--';

      // Migration correlation
      if (current.migration_correlation) {
        document.getElementById('migration-correlation').textContent = current.migration_correlation;
      }

      // Sparkline — include current reading at end
      const fullHistory = [...(history || []), current];
      if (fullHistory.length > 1) buildSparkline(fullHistory.slice(-12));

      // Show content
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    }

    // ─── LOAD DATA ─────────────────────────────────────────────
    fetch('data.json?v=' + Date.now())
      .then(r => {
        if (!r.ok) throw new Error('Failed to load data.json: ' + r.status);
        return r.json();
      })
      .then(data => {
        renderDashboard(data.current, data.history);
        initInfoTooltips();
      })
      .catch(err => {
        document.getElementById('loading-state').innerHTML = `
          <div class="text-center text-red-400 py-20">
            <p class="text-lg font-bold mb-2">Failed to load CVI data</p>
            <p class="text-sm text-slate-500">${err.message}</p>
            <p class="text-xs text-slate-600 mt-2">Make sure data.json exists and you're serving via HTTP (not file://)</p>
          </div>`;
      });
  </script>

</body>
</html>
